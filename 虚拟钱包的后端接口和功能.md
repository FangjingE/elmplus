[TOC]

## 钱包业务背景介绍

链接：(180条消息) 设计模式：如何利用基于充血模型的DDD开发一个虚拟钱包系统？_OceanStar的学习笔记的博客-CSDN博客](https://blog.csdn.net/zhizhengguan/article/details/122203737)

很多具有支付、购买功能的应用（比如淘宝、滴滴出行、[极客时间](https://so.csdn.net/so/search?q=极客时间&spm=1001.2101.3001.7020)等）都支持钱包的功能。应用为每个用户开设一个系统内的虚拟钱包账户，支持用户充值、提现、支付、冻结、透支、转赠、查询账户余额、查询交易流水等操作。

![在这里插入图片描述](https://img-blog.csdnimg.cn/7370abb789604e339718d0e1e40c0859.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAT2NlYW4mJlN0YXI=,size_20,color_FFFFFF,t_70,g_se,x_16)

一般来讲，每个虚拟钱包账户都会对应用户的一个真实的支付账户，有可能是银行卡账户，也有可能是三方支付账户（比如支付宝、微信钱包）。为了方便后续的讲解，我们限定钱包暂时只支持充值、提现、支付、查询余额、查询交易流水这五个核心的功能，其他比如冻结、透支、转赠等不常用的功能，我们暂不考虑。

### 充值

用户通过三方支付渠道，把自己银行卡账户内的钱，充值到虚拟钱包账号中。这整个过程，我们可以分解为三个主要的操作流程：

- 第一个操作是从用户的银行卡账户转账到应用的公共银行卡账户
- 第二个操作是将用户的充值金额加到虚拟钱包余额上
- 第三个操作是记录刚刚这笔交易流水

![在这里插入图片描述](https://img-blog.csdnimg.cn/ba7dd82e405642fda71039e6b735fc43.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAT2NlYW4mJlN0YXI=,size_19,color_FFFFFF,t_70,g_se,x_16)

### 支付

用户用钱包内的余额，支付购买应用内的商品。

- 实际上，支付的过程就是一个转账的过程，从用户的虚拟钱包账户划钱到商家的虚拟钱包账户上，然后触发真正的银行转账操作，从应用的公共银行账户转钱到商家的银行账户（注意，这里并不是从用户的银行账户转钱到商家的银行账户）。
- 除此之外，我们也需要记录这笔支付的交易流水信息。

![在这里插入图片描述](https://img-blog.csdnimg.cn/778ff4bf658c4893b329d109639db841.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAT2NlYW4mJlN0YXI=,size_20,color_FFFFFF,t_70,g_se,x_16)

### 提现

除了充值、支付之外，用户还可以将虚拟钱包中的余额，提现到自己的银行卡中。

- 这个过程实际上就是扣减用户虚拟钱包中的余额，并且触发真正的银行转账操作，从应用的公共银行账户转钱到用户的银行账户。
- 同样，我们也需要记录这笔提现的交易流水信息。

![在这里插入图片描述](https://img-blog.csdnimg.cn/a825d86f56b84dd48a1d5a4f16082913.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAT2NlYW4mJlN0YXI=,size_20,color_FFFFFF,t_70,g_se,x_16)

### 查询余额

查询余额功能比较简单，我们看一下虚拟钱包中的余额数字即可。

### 查询交易流水

查询交易流水也比较简单。我们只支持三种类型的交易流水：充值、支付、提现。

- 在用户充值、支付、提现的时候，我们会记录相应的交易信息。
- 在需要查询的时候，我们只需要将之前记录的交易流水，按照时间、类型等条件过滤之后，显示出来即可。

## 钱包系统的设计思路

根据刚刚讲的业务实现流程和数据流转图，我们可以把整个钱包系统的业务划分为两部分，其中一部分单纯跟应用内的虚拟钱包账户打交道，另一部分单纯跟银行账户打交道。我们基于这样一个业务划分，给系统解耦，将整个钱包系统拆分为两个子系统：虚拟钱包系统和三方支付系统。

![在这里插入图片描述](https://img-blog.csdnimg.cn/7cb003723a994602863e7f1c6ab3fdbd.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAT2NlYW4mJlN0YXI=,size_17,color_FFFFFF,t_70,g_se,x_16)
为了能在有限的篇幅内，将今天的内容讲透彻，我们接来下只聚焦于虚拟钱包系统的设计与实现。

> 现在我们来看下，如果要支持钱包的这五个核心功能，虚拟钱包系统需要对应实现哪些操作。

下图列出了这五个功能都会对应虚拟钱包的哪些操作。注意，交易流水的记录和查询，在图中打了个问号，那是因为这块比较特殊，我们待会再讲。

![在这里插入图片描述](https://img-blog.csdnimg.cn/d150aea3756e4d2eae9dc5a3e3e26745.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAT2NlYW4mJlN0YXI=,size_17,color_FFFFFF,t_70,g_se,x_16)
从图中我们可以看出，虚拟钱包系统要支持的操作非常简单，就是余额的加加减减。

- 其中，充值、提现、查询余额三个功能，只涉及一个账户余额的加减操作
- 而支付功能涉及两个账户的余额加减操作：一个账户减余额，另一个账户加余额。

> 现在，我们再来看一下图中问号的那部分，**也就是交易流水该如何记录和查询**？

我们先来看一下，交易流水都需要包含哪些信息：
![在这里插入图片描述](https://img-blog.csdnimg.cn/2953bc9e58f24360be8f6987d0e9e946.png)

- 从图中我们可以发现，交易流水的数据格式包含两个钱包账号，一个是入账钱包账号，一个是出账钱包账号。为什么要有两个账号信息呢？这主要是为了兼容支付这种涉及两个账户的交易类型。不过，对于充值、体现这两种交易类型来说，我们只需要记录一个钱包账号信息就够了。所以，这样的交易流水数据格式的设计稍微有点浪费存储空间。
- 实际上，我们还有另外一种交易流水格式的设计思路，可以解决这个问题。我们把“支付”这个较类型，拆分为两个子类型：支付和被支付。支付单纯表示出账，余额扣减，被支付单纯表示入账，余额增加。这样我们在设计交易流水数据格式的时候，只需要记录一个账户信息即可。

![在这里插入图片描述](https://img-blog.csdnimg.cn/9a1818d8e5f04317ac17d0a54173e491.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAT2NlYW4mJlN0YXI=,size_17,color_FFFFFF,t_70,g_se,x_16)
那以上两种交易流水数据格式的设计思路，哪一个更好呢？

- 第一种设计思路更好些。因为交易流水有两个功能：一个是业务功能。比如，提供用户查询交易流水信息；另一个是非业务功能，保证数据一致性。这里主要指支付操作数据的一致性。
- 支付实际上就是一个转账的操作，在一个账户上加上一定的金额，在另一个账户上减去相应的金额。我们需要保证加金额和减金额这两个操作，要么都成功，要么都失败。如果一个成功，一个失败，就会导致不一致，一个账户明明减掉了钱，另一个账户却没有收到钱。
- 保证数据一致性的方法有很多。
  - 比如依赖数据库事务的原子性，将两个操作放在同一个事务
    中执行。但是，这样的做法不够灵活，因为我们的有可能做了分库分表，支付涉及的两个账户可能存储在不同的库中，无法直接利用数据库本身的事务特性，在一个事务中执行两个账户的操作
  - 当然，我们还有一些支持分布式事务的开源框架，但是，为了保证数据的强一致性，它们的实现逻辑一般比较复杂，本身性能也不高，会影响业务的执行时间。
  - 所以，更加权衡的一种做法就是，不保证数据的强一致性，只实现数据的最终一致性，也就是我们刚刚提到的交易流水要实现的非业务功能
- 对于支付这样的类似转账的操作，我们在操作两个钱包余额之前，先记录交易流水，并且标记为“待执行”，当两个钱包的加减金额都完成之后，我们在回过头来，将交易流水标记为“成功”。在给两个钱包加减金额的过程中，如果有任意一个操作失败，我们就将交易记录的状态标记为“失败”。我们通过后台补漏 Job，拉取状态为“失败”或者长时间处于“待执行”状态的交易记录，重新执行或者人工介入处理。
- 如果选择第二种交易流水的设计思路，使用两条交易流水来记录支付操作，那记录两条交易流水本身又存在数据的一致性问题，有可能入账的交易流水记录成功，出账的交易流水信息记录失败。所以，权衡利弊，我们选择第一种稍微有些冗余的数据格式设计思路。

> 现在，我们再思考这样一个问题：充值、体现、支付这些业务交易类型，是否应该让虚拟钱包系统感知？换句话说，我们是否应该在虚拟钱包系统的交易流水中记录这三种类型？

虚拟钱包系统不应该感知具体的业务交易类型

- 虚拟钱包系统支持的操作，仅仅是余额的加加减减，不涉及复杂业务概念，职责单一、功能通用
- 如果耦合太多业务概念到里面，势必会影响系统的通用性，而且还会导致系统越来越复杂

因此，我们不希望将充值、支付、提现这样的业务概念添加到虚拟钱包系统中。

> 但是，如果我们不在虚拟钱包系统的交易流水中记录交易类型，那在用户查询交易流水的时候，如何显示每条交易流水的交易类型呢？

从系统设计的角度，我们不应该在虚拟钱包系统的交易流水中记录交易类型。从产品需求的角度来说，我们又必须记录交易流水的交易类型。听起来比较矛盾，这个问题该如何解决呢？

- 我们可以通过记录两条交易流水信息的方式来解决。上面提到，整个钱包系统分为两个子系统，它可以感知充值、支付、体现等业务概念
- 所以，我们在钱包系统的这一层额外再记录一条包含交易类型的交易流水信息，而底层虚拟钱包系统中记录不包含交易类型的交易流水信息

![在这里插入图片描述](https://img-blog.csdnimg.cn/6d1dae17bba545b6bf8af3d4cbd32da4.png)
我们通过查询上层钱包系统的交易流水信息，去满足用户查询交易流水的功能需求，而虚拟钱包中的交易流水就只是用来解决数据一致性问题。实际上，它的作用还有很多，比如用来对账等。

整个虚拟钱包的设计思路到此讲完了。



## 功能与接口

### 1.根据用户id（用户id=钱包id）返回对应的钱包，属性有balance（余额），id（名称）

![image-20221117165257181](C:\Users\fanglaozu\AppData\Roaming\Typora\typora-user-images\image-20221117165257181.png)

### 2.根据用户id返回余额（即查询余额）和上面的功能有重合。这两个功能合起来对前端的要求就是：能发出id请求，接收然后展示balance和id。

![image-20221117165906348](C:\Users\fanglaozu\AppData\Roaming\Typora\typora-user-images\image-20221117165906348.png)

### 3.出账（debit）。可以是提现或者购买商品。出账请求只操作数据库，出账后的余额不展示。 

![image-20221117170846139](C:\Users\fanglaozu\AppData\Roaming\Typora\typora-user-images\image-20221117170846139.png)

从数据库中可以看到用户11111111111的余额变成了224

![image-20221117170954897](C:\Users\fanglaozu\AppData\Roaming\Typora\typora-user-images\image-20221117170954897.png)

### 4.入账(credit)。和出账差不多

![image-20221117171111319](C:\Users\fanglaozu\AppData\Roaming\Typora\typora-user-images\image-20221117171111319.png)

余额变回274

![image-20221117171142951](C:\Users\fanglaozu\AppData\Roaming\Typora\typora-user-images\image-20221117171142951.png)

### 5.转账（transfer）。三个输入，fromUserId（出账账号）, toUserId（入账账号）, amount(金额)

![image-20221117203743686](C:\Users\fanglaozu\AppData\Roaming\Typora\typora-user-images\image-20221117203743686.png)

![image-20221117203902030](C:\Users\fanglaozu\AppData\Roaming\Typora\typora-user-images\image-20221117203902030.png)

### 6.查询流水。返回id为111111111的用户的所有流水记录

![image-20221117204053732](C:\Users\fanglaozu\AppData\Roaming\Typora\typora-user-images\image-20221117204053732.png)



之前的支付功能没有实现，现在要依靠虚拟钱包去实现支付功能

![image-20221117211548816](C:\Users\fanglaozu\AppData\Roaming\Typora\typora-user-images\image-20221117211548816.png)

![image-20221117211442110](C:\Users\fanglaozu\AppData\Roaming\Typora\typora-user-images\image-20221117211442110.png)

## 注

**商家id和用户id即为钱包id，也就是应当在用户在登录状态下可以用自己的userid作为getWalletbyuserId等方法的参数从而找到对应的钱包，作查询余额，出入帐等操作**